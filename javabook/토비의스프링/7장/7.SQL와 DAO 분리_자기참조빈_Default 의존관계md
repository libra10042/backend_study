# ğŸª”ìŠ¤í”„ë§ í•µì‹¬ ê¸°ìˆ ì˜ ì‘ìš©

## SQL ê³¼ DAO ì˜ ë¶„ë¦¬ 

> 1) XML ì„¤ì •ì„ ì´ìš©í•œ ë¶„ë¦¬ 
> - ê°œë³„ SQLí”„ë¡œí¼í‹° ë°©ì‹
> - SQL ë§µ í”„ë¡œí¼í‹° ë°©ì‹. 
> 2) ë¦¬íŒ©í† ë§ <br>
> - â˜‘SQL ì œê³µì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•˜ëŠ” ë°©ì‹. 
> - â˜‘ìŠ¤í”„ë§ ì„¤ì •ì„ ì‚¬ìš©í•˜ëŠ” ë‹¨ìˆœ SQL 

### ê°œë³„ SQL í”„ë¡œí¼í‹° ë°©ì‹. 

```JAVA
public class UserDaoJdbc implements UserDao {
    private String sqlAdd; 
    
    public void setSqlAdd(String sqlAdd){
        this.sqlAdd = sqlAdd;
    }
      
```

```JAVA
public void add(User user) {
    this.jdbcTemplate.update(
        this.sqlAdd, 
        user.getId(), user.getName(), user.getPassword(), user.getEmail(),
        user.getLevel().intValue(), user.getLogin(), user.getRecommand());
}
```

```JAVA
<bean id="userDao" class="springboot.user.dao.UserDaoJdbc">
    <property name="dataSource" ref="dataSource" />
    <property name="sqlAdd" value="insert into users(id, name, password, 
        email, level, login, recommand)  values(?,?,?,?,?,?,?)" />
```

### SQL ë§µ í”„ë¡œí¼í‹° ë°©ì‹. 

: UserDaoì—ì„œ SQLì„ ì£¼ì…ë°›ê¸° ìœ„í•´ ê°œë³„ì ìœ¼ë¡œ ì •ì˜í•œ í”„ë¡œí¼í‹°ë¥¼ ëª¨ë‘ ì œê±°í•˜ì. <br>ê·¸ë¦¬ê³  Map íƒ€ì…ì˜ sqlMapì„ ëŒ€ì‹  ì¶”ê°€í•œë‹¤.

```java
public class UserDaoJdbc implements UserDao{

    private Map<String, String> sqlMap;
    
    public void setSqlMap(Map<String, String> sqlMap){
        this.sqlMap = sqlMap;
    }
}
```

```java
public void add(User user){
    this.jdbcTemplate.update(
        this.sqlMap.get("add"),
        user.getId(), user.getName(), user.getPassword(), user.getEmail(), 
        user.getLevel().intValue(), user.getLogin(), user.getRecommand());
    )
```

```java
<bean id="uerDao" class="springbook.user.dao.UserDaoJdbc">
    <property name="dataSource" ref="dataSource" />
    <property name="sqlMap">
         <map>    
              <entry key="add" value="insert into users(id, name, password, email, level, login, recommend)
                                      valuse(?,?,?,?,?,?,?)" />
              <entry key="get" value="select * from users where id=?" />
              <entry key="getAll" value="select * from users order by id" />
              <entry key="deleteAll" value="delete from users" />
              <entry key="getCount" value="select count(*) from users" />
              <entry key="update" value="update users set name = ?, password = ?, email = ?, level =?, 
                                          login = ?, recommand = ? where id = ?" />
         </map>
    </property>
</bean>
```

" sql ë§µ í”„ë¡œí¼í‹° ë°©ì‹ì€ í•´ë‹¹ ë©”ì†Œë“œê°€ ì‹¤í–‰ë˜ê¸° ì „ì—ëŠ” ì˜¤ë¥˜ë¥¼ í™•ì¸í•˜ê¸° í˜ë“¤ë‹¤ëŠ” ë‹¨ì ì´ ìˆë‹¤. "

<br>

### â˜‘SQL ì œê³µ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•œ ë°©ì‹. 

##### SqlService ì¸í„°í˜ì´ìŠ¤

```java
public interface SqlService{
     String getSql(String key) throws SqlRetrievalFailureException;

}
```

* SqlRetrievalFailureException : ì´ ì˜ˆì™¸ëŠ” ë³µêµ¬ê°€ ë¶ˆê°€ëŠ¥í•˜ë¯€ë¡œ ëŸ°íƒ€ì„ ì˜ˆì™¸ë¡œ ì •ì˜í•´ ë‘”ë‹¤.

##### SQL ì¡°íšŒ ì‹¤íŒ¨ ì‹œ ì˜ˆì™¸

```java
public class SqlRetrievalFailureException extends RuntimeException {
     public SqlRetrievalFailureException(String message){
        super(message);
     }
     
     public SqlRetrievalFailureException(String message, Throwable cause){
        super(message, cause);
     }
}
```

##### SqlService í”„ë¡œí¼í‹° ì¶”ê°€. 

```java
public class UserDaoJdbc implements UserDao{
    private SqlService sqlService; 
    
    public void setSqlService(SqlService sqlService){
        this.sqlService = sqlService; 
    }
}
```

##### sqlService ë¥¼ ì‚¬ìš©í•˜ë„ë¡ ìˆ˜ì •í•œ ë©”ì†Œë“œ

```java
public void add(User user){
    this.jdbcTemplate.update(this.sqlService.getSql("userAdd"),
          user.getId(), user.getName(), user.getPassword(), user.getEmail(), 
          user.getLevel().intValue(), user.getLogin(), user.getRecommand());
}
    
public User get(String id){
    return this.jdbcTemplate.queryForObject(this.sqlService.getSql("userGet"),
        new Object[] {id}, this.userMapper);
}
   
public List<User> getAll(){
    return this.jdbcTemplate.query(this.sqlService.getSql("userGetAll"),
          this.userMapper);
}

public int getCount(){
    return this.jdbcTemplate.queryForInt(this.sqlService.getSql("userGetCount"));
}

public void update(User user){
    this.jdbcTemplate.update(this.sqlService.getSql("userUpdate"),
        user.getName(), user.getPassword(), user.getEmail(), 
        user.getLevel().intValue(), user.getLogin(), user.getRecommand(), 
        user.getId()); 
}

```


#### â˜‘ìŠ¤í”„ë§ ì„¤ì •ì„ ì‚¬ìš©í•˜ëŠ” ë‹¨ìˆœ SQL ì„œë¹„ìŠ¤

```java

public class SimpleService implements SqlService{
    private Map<String, String> sqlMap;
    
    public void setSqlMap<String, String> sqlMap){
        this.sqlMap = sqlMap; 
    }
    
    
    public String getSql(String key) throws SqlRetrievalFailureException {
        String sql = sqlMap.get(key);
        
        if(sql == null)
            throw new SqlRetrievalFailureException( key + "ì— ëŒ€í•œ SQLì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
        else {
            return sql; 
    }
}
```

```java
<bean id="userDao" class="springbook.dao.userDaoJdbc">
    <property name="dataSource" ref="dataSource" />
    <property name="sqlService" ref="sqlService" />
</bean>

<bean id="sqlService" class="springbook.user.sqlservice.SimpleSqlService">
    <property name"sqlMap">
        <map>
            <entry key="userAdd" value="insert into user(id, name, password, email, level, login, recomned) values(?, ?, ?, ?, ?, ?, ?)" />
            <entry key="userGet" value="select * from users where id = ?" />
            <entry key="userGetAll" value="select * from users order by id" />
            <entry key="userDeleteAll" value="delete from users" />
            <entry key="userGetCount" value="select count(*) from users" />
            <entry key="userUpdate" value="update users set name = ?, password = ?, email = ?, level = ?, login = ?, recommand = ? where id = ?" />
        </map>
    </property>
</bean>
```


----

## ì¸í„°í˜ì´ìŠ¤ ë¶„ë¦¬ì™€ ìê¸°ì°¸ì¡° ë¹ˆ. 

### XML íŒŒì¼ ë§¤í•‘ 

> - â˜‘JAXB
> - â˜‘SQL ë§µì„ ìœ„í•œ ìŠ¤í‚¤ë§ˆ ì‘ì„±ê³¼ ì»´íŒŒì¼ 
> - â˜‘ì–¸ë§ˆìƒ¬ë§

#### â˜‘JAXB

 : XMLì— ë‹´ê¸´ ì •ë³´ë¥¼ íŒŒì¼ì—ì„œ ì½ì–´ì˜¤ëŠ” ë°©ë²•ì€ ì—¬ëŸ¬ê°€ì§€ ì¸ë° ê·¸ì¤‘ í•˜ë‚˜ê°€ JAXB (Java Architecture for XML Binding)ë¥¼ ì´ìš©í–ˆë‹¤. 
 
 * "DOM" ê³¼ ê°™ì€ ì „í†µì ì¸ XML API ì™€ ë¹„êµí–ˆì„ ë•Œ JAXBì˜ ì¥ì ì€ XML ë¬¸ì„œì •ë³´ë¥¼ ê±°ì˜ ë™ì¼í•œ êµ¬ì¡°ì˜ ì˜¤ë¸Œì íŠ¸ë¡œ ì§ì ‘ ë§¤í•‘í•´ì¤€ë‹¤ëŠ” ê²ƒì´ë‹¤. 
 * "DOM"ì€ XML ì •ë³´ë¥¼ ë§ˆì¹˜ ìë°”ì˜ ë¦¬í”Œë ‰ì…˜ APIë¥¼ ì‚¬ìš©í•´ì„œ ì˜¤ë¸Œì íŠ¸ë¥¼ ì¡°ì‘í•˜ëŠ” ê²ƒì²˜ëŸ¼ ê°„ì ‘ì ìœ¼ë¡œ ì ‘ê·¼í•´ì•¼ í•˜ëŠ” ë¶ˆí¸ì´ ìˆë‹¤.
 * "JAXB"ëŠ” XMLì˜ ì •ë³´ë¥¼ ê·¸ëŒ€ë¡œ ë‹´ê³  ìˆëŠ” ì˜¤ë¸Œì íŠ¸ íŠ¸ë¦¬ êµ¬ì¡°ë¡œ ë§Œë“¤ì–´ì£¼ê¸° ë•Œë¬¸ì— XML ì •ë³´ë¥¼ ì˜¤ë¸Œì íŠ¸ì²˜ëŸ¼ ë‹¤ë£° ìˆ˜ ìˆì–´ í¸ë¦¬í•˜ë‹¤. 
 * "JAXB"ëŠ” XML ë¬¸ì„œì˜ êµ¬ì¡°ë¥¼ ì •ì˜í•œ ìŠ¤í‚¤ë§ˆë¥¼ ì´ìš©í•´ì„œ ë§¤í•‘í•  ì˜¤ë¸Œì íŠ¸ì˜ í´ë˜ìŠ¤ê¹Œì§€ ìë™ìœ¼ë¡œ ë§Œë“¤ì–´ì£¼ëŠ” ì»´íŒŒì¼ëŸ¬ë„ ì œê³µí•´ì¤€ë‹¤.
 ( ìŠ¤í‚¤ë§ˆ ì»´íŒŒì¼ëŸ¬ë¥¼ í†µí•´ ìë™ìƒì„±ëœ ì˜¤ë¸Œì íŠ¸ì—ëŠ” ë§¤í•‘ì •ë³´ê°€ ì• ë…¸í…Œì´ì…˜ìœ¼ë¡œ ë‹´ê²¨ ìˆë‹¤. <br> JAXB APIëŠ” ì• ë…¸í…Œì´ì…˜ì— ë‹´ê¸´ ì •ë³´ë¥¼ ì´ìš©í•´ì„œ XML ê³¼ ë§¤í•‘ëœ ì˜¤ë¸Œì íŠ¸ íŠ¸ë¦¬ ì‚¬ì´ì˜ ìë™ë³€í™˜ ì‘ì—…ì„ ìˆ˜í–‰í•´ ì¤€ë‹¤. )  
 
 
 <br>
 
 #### SQL ë§µì„ ìœ„í•œ ìŠ¤í‚¤ë§ˆ ì‘ì„±ê³¼ ì»´íŒŒì¼ 
 
 : SQL ì •ë³´ëŠ” í‚¤ì™€ SQLì˜ ëª©ë¡ìœ¼ë¡œ êµ¬ì„±ëœ ë§µ êµ¬ì¡°ë¡œ ë§Œë“¤ì–´ë‘ë©´ í¸ë¦¬í•˜ë‹¤. 
 
 ##### SQL ë§µ XML ë¬¸ì„œ
 
 ```JAVA
 <sqlmap>
        <sql key="userAdd"> insert into users(...) ...</sql>
        <sql key="userGet"> select * from users ... </sql>

 </sqlmap> 
 ```
 
 ###### SQL ë§µ ë¬¸ì„œì— ëŒ€í•œ ìŠ¤í‚¤ë§ˆ
 
 ```JAVA
 <? xml version="1.0" encoding="UTF-8"?>
 <schema xmlns="http://www.w3.org/2001/XMLSchema"
        targetNamespace="http://www.epril.com/sqlmap"
        xmlns:tns="http://www,epril.com/sqlmap" elementFormDefault="qualified">
        
        <element name="sqlmap">
              <complexType>
                    <sequence>      
                        <element name="sql" maxOccurs="unbounded" type="tns:sqlType" />
                    </sequence>
              </complexType>
        </element>
        <complexType name="sqlType">
               <simpleContent>
                     <extension base="string">
                            <attribute name="key" use="required" type="string" />
                     </extension>
               </simpleContent>
        </complexType>
</schema>
```


###### SqlmapType í´ë˜ìŠ¤

```java
@XmlAccessorType(XmlAccessType.FIELD)
@XmlType(name = "sqlmapType", propOrder = { "sql" })
@XmlRootElement(name = "sqlmap")
public class SqlMap {
    @XmlElement(required = true)
    protected List<SqlType> sql;
    
    public List<SqlType> getSql(){
        if(sql == null){
            sql = new ArrayList<SqlType>();
        }
        return this.sql;
    }
}
```

```java
@XmlAccessorType(XmlAccessType.FIELD)
@XmlType(name = "sqlType", propOrder = {"value"} )
public class SqlType {    // <sql> íƒœê·¸ í•œ ê°œë‹¹ SqlType ì˜¤ë¸Œì íŠ¸ê°€ í•˜ë‚˜ì”© ë§Œë“¤ì–´ì§„ë‹¤. 

    @XmlValue
    protected String value;  // SQL ê°’ì„ ì €ì¥í•  ìŠ¤íŠ¸ë§ íƒ€ì…ì˜ í•„ë“œ
    
    @XmlAttribute(required = true)
    protected String key; 
    
    public String getValue(){
        return value; 
    }
    
    public void setValue(String value){
        this.value = value;
    }
    
    public String getKey(){
        return key; 
    }
    
    public void setKey(String value){
        this.key = value; 
    }


}
```

### â˜‘ì–¸ë§ˆìƒ¬ë§

: ìƒì„±ëœ ë§¤í•‘ í´ë˜ìŠ¤ë¥¼ ì ìš©í•˜ê¸° ì „ì— ë¨¼ì € JAXB API ì˜ ì‚¬ìš©ë²•ì„ ìµí ìˆ˜ ìˆë„ë¡ ê°„ë‹¨í•œ í•™ìŠµ í…ŒìŠ¤íŠ¸ë¥¼ ë§Œë“¤ì–´ë³´ì. 

##### í…ŒìŠ¤íŠ¸ìš© SQL ë§µ XML ë¬¸ì„œ

```java
<? xml version="1.0" encoding="UTF-8"?>
<sqlmap xmlns="http://www.epril.com/sqlmap"
            xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
            xsi:schemaLocation="http://www.epril.com/sqlmap ../../../../sqlmap.xsd ">
            <sql key="add">insert</sql>
            <sql key="get">select</sql>
            <sql key="delete">delete></sql>
</sqlmap>
```

* sqlmap.xmlì´ JAXB ì–¸ë§ˆìƒ¬ë§ì„ í†µí•´ ë§¤í•‘ ì˜¤ë¸Œì íŠ¸ë¡œ ë³€í™˜ë˜ëŠ”ì§€ í™•ì¸í•´ë³´ì.

##### JAXB í•™ìŠµ í…ŒìŠ¤íŠ¸

```java
public class JaxbTest {

    @Test
    public void readSqlmap() throws JAXBException, IOException {
        String contextPath = Sqlmap.class.getPackage().getName(); 
        JAXBContext context = JAXBContext.newInstance(contextPath);  // ë°”ì¸ë”©ìš© í´ë˜ìŠ¤ë“¤ ìœ„ì¹˜ë¥¼ ê°€ì§€ê³  JAXB ì»¨í…ìŠ¤íŠ¸ë¥¼ ë§Œë“ ë‹¤.
        
        
        Unmarshaller unmashaller = context.createUnmarshaller();  // ì–¸ë§ˆìƒ¬ëŸ¬ ìƒì„±
        
        Sqlmap sqlmap = (Sqlmap) unmarshaller.unmarshal(          // ì–¸ë§ˆìƒ¬ì„ í•˜ë©´ ë§¤í•‘ëœ ì˜¤ë¸Œì íŠ¸ íŠ¸ë¦¬ì˜ ë£¨íŠ¸ì¸ Sqlmapì„ ëŒë ¤ì¤€ë‹¤.
                getClass().getResourceAsStream("sqlmap.xml")); 
        
        List<SqlType> sqlList = sqlmap.getSql(); 
        
        assertThat(sqlList.size(), is(3)); 
        assertThat(sqlList.get(0).getKey(), is("add"));
        assertThat(sqlList.get(0).getValue(), is("insert"));
        assertThat(sqlList.get(1).getKey(), is("get"));
        assertThat(sqlList.get(1).getValue(), is("select"));
        assertThat(sqlList.get(2).getKey(), is("delete"));
        assertThat(sqlList.get(3).getValue(), is("delete"));        // Listì— ë‹´ê²¨ ìˆëŠ” sql ì˜¤ë¸Œì íŠ¸ë¥¼ ê°€ì ¸ì™€ XML ë¬¸ì„œì™€ ê°™ì€ ì •ë³´ë¥¼ ê°–ê³  ìˆëŠ”ì§€ í™•ì¸í•œë‹¤.
    }
}
```

<br>

---

### â˜‘XML íŒŒì¼ì„ ì´ìš©í•˜ëŠ” SQL ì„œë¹„ìŠ¤

> âš€SQL ë§µ XML íŒŒì¼  <br>
> âš€ë¹ˆì˜ ì´ˆê¸°í™” ì‘ì—… <br>
> âš€ë³€í™”ë¥¼ ìœ„í•œ ì¤€ë¹„ : ì¸í„°í˜ì´ìŠ¤ ë¶„ë¦¬ <br>
> <br>
> âš€ìê¸° ì°¸ì¡°ë¹ˆìœ¼ë¡œ ì‹œì‘í•˜ê¸° <br>
> - 1.  ì¸í„°í˜ì´ìŠ¤ë¥¼ ì´ìš©í•œ ë¶„ë¦¬ <br>
> - 2.  ìê¸°ì°¸ì¡° ë¹ˆ ì„¤ì • <br>
> <br>
> âš€ë””í…íŠ¸ ì˜ì¡´ê´€ê³„ <br>
> - 1.  í™•ì¥ ê°€ëŠ¥í•œ ê¸°ë°˜ í´ë˜ìŠ¤
> - 2.  ë””í´íŠ¸ ì˜ì¡´ê´€ê³„ë¥¼ ê°–ëŠ” ë¹ˆ ë§Œë“¤ê¸° 

#### âš€SQL ë§µ XML íŒŒì¼

```JAVA
<?xml version="1.0" encoding="UTF-8?>
<sqlmap xmlns="http://www.epril.com/sqlmap"
            xmlns="http://www.w3.org/2001/XMLSchema-instance"
            xsi:schemaLocation="http://www.epril.com/sqlmap
                            http://www.epril.com/sqlmapsqlmap.xsd">
    <sql key="userAdd">insert into users(id, name, password, email, level, login, recommend) values(?,?,?,?,?,?,?) </sql>
    <sql key="userGet">select * from users where id = ?</sql>
    <sql key="userGetAll">select * from users order by id</sql>
    <sql key="userDeleteAll">delete from users</sql>
    <sql key="userGetCount'>select count(*) from users</sql>
    <sql key="userUpdate">update users set name = ?, password = ?, email = ?, level = ?, login =?, recommend = ? where id = ? </sql>

</sqlmap>
```

#### XML SQL ì„œë¹„ìŠ¤ 

: ì–¸ì œ JAXBë¥¼ ì‚¬ìš©í•´ XML ë¬¸ì„œë¥¼ ê°€ì ¸ì˜¬ì§€ ìƒê°í•´ë´ì•¼ í•œë‹¤. 

* DAO ê°€ SQL ì„ ìš”ì²­í•  ë•Œë§ˆë‹¤ ë§¤ë²ˆ XML íŒŒì¼ì„ ë‹¤ì‹œ ì½ì–´ì„œ SQLì„ ì°¾ëŠ” ê±´ ë„ˆë¬´ ë¹„íš¨ìœ¨ì ì¸ ë°©ë²•ì´ë‹¤. <br>
* íŠ¹ë³„í•œ ì´ìœ ê°€ ì—†ëŠ” í•œ XML íŒŒì¼ì€ í•œ ë²ˆë§Œ ì½ë„ë¡ í•´ì•¼ í•œë‹¤. 

##### ìƒì„±ì ì´ˆê¸°í™” ë°©ë²•ì„ ì‚¬ìš©í•˜ëŠ” XmlSqlService  í´ë˜ìŠ¤

```java
public class XmlSqlService implements SqlService {
    private Map<String, String> sqlMap = new HashMap<String, String>();
    
    public XmlSqlService(){
    
        String contextPath = Sqlmap.class.getPackage().getName(); 
        try{
            JAXBContext context = JAXBContext.newInstance(contextPath);
            Unmarshaller unmarshaller = context.createUnmarshaller();
            InputStream is = UserDao.class.getResourceAsStream("sqlmap.xml");
            Sqlmap sqlmap = (Sqlmap) unmarshaller.unmarshal(is);
            
            
            for(SqlType sql : sqlmap.getSql()){
                sqlMap.put(sql.getKey(), sql.getValue());
                    
            }
        
        }catch(JAXBException e)}
            throw new RuntimeException(e); 
        }
    }
    public String getSql(String key) throws SqlRetrievalFailureException {
        String sql = sqlMap.get(key);
        if(sql == null)
            throw new SqlRetrievalFailureException(key + "ë¥¼ ì´ìš©í•´ì„œ SQLì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        else 
            return sql; 
    }
}
```

##### sqlService ì„¤ì • ë³€ê²½

```java
<bean id="sqlService" class="springbook.user.sqlservice.XmlSqlService">
</bean>
```
<br> <br>

### âš€ë¹ˆì˜ ì´ˆê¸°í™” ì‘ì—…. 

##### SQL ë§µ íŒŒì¼ ì´ë¦„ í”„ë¡œí¼í‹°

```java
private String sqlmapFile;

public void setSqlmapFile(String sqlmapFile){
    this.sampleFile = sqlmapFile; 
}
```

##### ìƒì„±ì ëŒ€ì‹  ì‚¬ìš©í•  ì´ˆê¸°í™” ë©”ì„œë“œ

```java
public void loadSql(){
    String contextPath = Sqlmap.class.getPackage().getName();
    
    try {
        ...
        InputStream is = UserDao.class.getResourceAsStream(this.sqlmapFile);
        ...
    }
}
```

##### XmlSqlService ì˜¤ë¸Œì íŠ¸ì˜ ì´ˆê¸°í™” ë°©ë²•

``` java
XmlSqlService sqlProvider = new XmlSqlService();
sqlProvider.setSqlmapFile("Sqlmap.xml");
sqlProvider.loadSql();
```

* XmlSqlService ì˜¤ë¸Œì íŠ¸ëŠ” ë¹ˆì´ë¯€ë¡œ ì œì–´ê¶Œì´ ìŠ¤í”„ë§ì— ìˆë‹¤.

âœğŸ» AOP ì—ì„œ ë¹ˆ í›„ì²˜ë¦¬ê¸°ì— ëŒ€í•´ ì„¤ëª…í–ˆë‹¤. <br> ë¹ˆ í›„ì²˜ë¦¬ê¸°ëŠ” ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆê°€ ë¹ˆì„ ìƒì„±í•œ ë’¤ì— ë¶€ê°€ì ì¸ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” íŠ¹ë³„í•œ ê¸°ëŠ¥ì´ë‹¤. <br>
AOPë¥¼ ìœ„í•œ í”„ë¡ì‹œ ìë™ìƒì„±ê¸°ê°€ ëŒ€í‘œì ì¸ ë¹ˆ í›„ì²˜ë¦¬ê¸°ë‹¤. í”„ë¡ì‹œ ìë™  ìƒì„±ê¸° ì™¸ì—ë„ ìŠ¤í”„ë§ì´ ì œê³µí•˜ëŠ” ì—¬ëŸ¬ ê°€ì§€ ë¹ˆ í›„ì²˜ë¦¬ê¸°ê°€ ì¡´ì¬í•œë‹¤. <br>
ê·¸ ì¤‘ì—ì„œ ì• ë…¸í…Œì´ì…˜ì„ ì´ìš©í•œ ë¹ˆ ì„¤ì •ì„ ì§€ì›í•´ì£¼ëŠ” ëª‡ ê°€ì§€ ë¹ˆ í›„ì²˜ë¦¬ê¸°ê°€ ì¡´ì¬í•œë‹¤. <br>
" < bean > " íƒœê·¸ë¥¼ ì´ìš©í•´ í•˜ë‚˜ì”© ë“±ë¡í•˜ëŠ” ë°©ë²•ë³´ë‹¤ëŠ” context ìŠ¤í‚¤ë§ˆì˜ annotation-config íƒœê·¸ë¥¼ ì‚¬ìš©í•˜ë©´ í¸ë¦¬í•˜ë‹¤. 
    
    
    
##### context ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì„ ì–¸ê³¼ annotation-config íƒœê·¸ ì„¤ì •. 
```java
<beans xmlns="http://www.springframework.rog/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:aop="http://www.springframework .org/schema/aop"
    xmlns:context="http://www.springframework.org/schema/context"   // context ìŠ¤í‚¤ë§ˆì— ì •ì˜ëœ íƒœê·¸ë¥¼ context ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ í†µí•´ ì‚¬ìš©í•˜ë„ë¡ ì •ì˜í•œë‹¤.
    xmlns:tx="http:www.springframework.org/schema/tx"
    xsi:schemaLocation="http://www.springframework.org/schema/beans
            http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
            http://www.springframework.org/schema/aop
            http://www.springframework.org.schema/aop/spring-aop-3.0.xsd
            http://www.springframework.org.schema/context
            http://www.springframework.org.schema/context/spring-context-3.0.xsd   // context ìŠ¤í‚¤ë§ˆì— ì •ì˜ëœ íƒœê·¸ë¥¼ context ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ í†µí•´ ì‚¬ìš©í•˜ë„ë¡ ì •ì˜í•œë‹¤.
            http://www.springframework.org/schema/tx
            http://www.springframework.org/schema/tx/spring-tx-3.0.xsd">
            
            
    <tx:annotation-driven />  // @Transaction ì´ ë¶™ì€ íƒ€ì…ê³¼ ë©”ì†Œë“œì— íŠ¸ëœì­ì…˜ ë¶€ê°€ê¸°ëŠ¥ì„ ë‹´ì€ í”„ë¡ì‹œë¥¼ ì¶”ê°€í•˜ë„ë¡ ë§Œë“¤ì–´ì£¼ëŠ” í›„ì²˜ë¦¬ê¸° ë“±ë¡
    
    <context:annotation-config /> // ì½”ë“œì˜ ì• ë…¸í…Œì´ì…˜ì„ ì´ìš©í•´ì„œ ë¶€ê°€ì ì¸ ë¹ˆ ì„¤ì • ë˜ëŠ” ì´ˆê¸°í™” ì‘ì—…ì„ í•´ì£¼ëŠ” í›„ì²˜ë¦¬ê¸°ë¥¼ ë“±ë¡. 
            
```


<br>

âœğŸ» PostConstruct : java.lang.annotation íŒ¨í‚¤ì§€ì— í¬í•¨ëœ ê³µí†µ ì• ë…¸í…Œì´ì…˜ì˜ í•œ ê°€ì§€ë¡œ JavaEE 5 ë‚˜ JDK 6ì— í¬í•¨ëœ í‘œì¤€ ì• ë…¸í…Œì´ì…˜ì´ë‹¤.

##### @PostConstruct ì´ˆê¸°í™” ë©”ì„œë“œ 

```java
public class XmlSqlService implements SqlService {
    ...
    @PostConstruct
    public void loadSql() {... }
    ...
}
```

##### sqlmapFile í”„ë¡œí¼í‹° ì¶”ê°€

```java
<bean id="sqlService" class="springbook.user.sqlservice.XmlSqlService">
    <property name="sqlmapFile" value="sqlmap.xml" />
</bean>
```

![image](https://user-images.githubusercontent.com/46278436/126776924-615083ad-38bf-4b0b-9119-cb4ee8e47e96.png)

<br>
<br>
<br>

### âš€ë³€í™”ë¥¼ ìœ„í•œ ì¤€ë¹„ : ì¸í„°í˜ì´ìŠ¤ ë¶„ë¦¬. 

> ì±…ì„ì— ë”°ë¥¸ ì¸í„°í˜ì´ìŠ¤ ì •ì˜


##### SqlService ì„œë¹„ìŠ¤ ì˜¤ë¸Œì íŠ¸ êµ¬ì¡°

![image](https://user-images.githubusercontent.com/46278436/126777950-aafbca3e-6893-427c-8ef1-43dddfb7d64f.png)


##### SqlService êµ¬í˜„ í´ë˜ìŠ¤ ì½”ë“œ

- SqlReaderê°€ ë¦¬ì†ŒìŠ¤ë¡œë¶€í„° ì½ì–´ì˜¨ SQL ì •ë³´ë¥¼ ë§µìœ¼ë¡œ ëŒë ¤ì¤€ë‹¤ê³  ì •ì˜í•˜ë©´ ì•„ë˜ì™€ ê°™ì€ ì½”ë“œê°€ ëœë‹¤.

```java
Map<String, String> sqls = sqlReader.readSql();  // Mapì´ë¼ëŠ” êµ¬ì²´ì ì¸ ì „ì†¡ íƒ€ì…ì„ ê°•ì œí•˜ê²Œ ëœë‹¤.
sqlRegistry.addSqls(sqls);
```

* Map íƒ€ì…ìœ¼ë¡œ SqlRegistryì— ì „ë‹¬í–ˆëŠ”ë° SqlRegistry ë‚´ë¶€ì—ì„œ 2ì°¨ì› ë°°ì—´ë¡œ ì €ì¥í•´ë‘ëŠ” ë°©ì‹ì„ ì‚¬ìš©í•œë‹¤ë©´, ë‹¤ì‹œ ë§µì—ì„œ ë°°ì—´ë¡œ ì˜®ê¸°ëŠ” ê³¼ì •ì´ í•„ìš”í•˜ë‹¤. <br>
* ì•„ë˜ì™€ ê°™ì´ Refactoring í•  ìˆ˜ ìˆë‹¤. 

##### SqlService êµ¬í˜„ í´ë˜ìŠ¤ Refactoring

```java
sqlReader.readSql(sqlRegistry);   // SQLì„ ì €ì¥í•  ëŒ€ìƒì¸ sqlRegistry ì˜¤ë¸Œì íŠ¸ë¥¼ ì „ë‹¬í•œë‹¤.
```

```java
interface SqlRegistry{
    void registerSql(String key, String sql);  // SqlReaderëŠ” ì½ì–´ë“¤ì¸ SQLì„ ì´ ë©”ì†Œë“œë¥¼ ì´ìš©í•´ ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— ì €ì¥í•œë‹¤.
    ...
}
```

âœğŸ» ì´ë ‡ê²Œ í•˜ë©´ SqlService ì½”ë“œë¥¼ í†µí•´ íŠ¹ì • í¬ë§·ìœ¼ë¡œ ë³€í™˜í•œ SQL ì •ë³´ë¥¼ ì£¼ê³ ë°›ì„ í•„ìš” ì—†ì´ SqlReaderê°€ ì§ì ‘ SqlRegistry ì— SQL ì •ë³´ë¥¼ ë“±ë¡í•  ìˆ˜ ìˆë‹¤. <br>
ì´ë ‡ê²Œ í•˜ë©´ SqlReaderì™€ SqlRegistryëŠ” ê°ìì˜ êµ¬í˜„ ë°©ì‹ì„ ë…ë¦½ì ìœ¼ë¡œ ìœ ì§€í•˜ë©´ì„œ ê¼­ í•„ìš”í•œ ê´€ê³„ë§Œ ê°€ì§€ê³  í˜‘ë ¥í•´ì„œ ì¼ì„ í•  ìˆ˜ ìˆëŠ” êµ¬ì¡°ê°€ ëœë‹¤.


<br>

##### SqlRegistry ì¸í„°í˜ì´ìŠ¤

```java
public interface SqlRegistry {
    void registerSql(String key, String sql);
    
    String findSql(String key) throws SqlNotFoundException; 
}
```

##### SqlReader ì¸í„°í˜ì´ìŠ¤

```java
public interface SqlReader {
    void read(SqlRegistry sqlRegistry); // SQLì„ ì™¸ë¶€ì—ì„œ ê°€ì ¸ì™€ SqlRegistryì— ë“±ë¡í•œë‹¤.
}
```


<br>
<br>

### âš€ìê¸°ì°¸ì¡° ë¹ˆìœ¼ë¡œ ì‹œì‘í•˜ê¸° 

##### SqlService ì„œë¹„ìŠ¤ì˜ í´ë˜ìŠ¤ì™€ ì˜ì¡´ê´€ê³„

![image](https://user-images.githubusercontent.com/46278436/126781933-180cfadc-7c2c-46be-93f4-a5a05f80f2dc.png)

* XmlSqlService í´ë˜ìŠ¤ëŠ” ì´ ì„¸ ê°€ì§€ ê´€ì‹¬ê³¼ ì±…ì„ì„ êµ¬ë¶„ ì—†ì´ í•˜ë‚˜ì˜ í´ë˜ìŠ¤ì— ë­‰ëš±ê·¸ë ¤ì„œ ë§Œë“¤ì–´ë†“ì•˜ë˜ ê²ƒì´ë‹¤. ì´ì œ ì´ê²ƒì„ ê° ì±…ì„ì— ë”°ë¼ êµ¬ë¶„í•  ì°¨ë¡€ë‹¤. 
* ìœ„ ê·¸ë¦¼ì—ì„œëŠ” ëª¨ë“  í´ë˜ìŠ¤ëŠ” ì¸í„°í˜ì´ìŠ¤ì—ë§Œ ì˜ì¡´í•˜ê³  ìˆìŒì„ ì•Œ ìˆ˜ ìˆë‹¤. 
* ì¸í„°í˜ì´ìŠ¤ì— ì˜ì¡´í•˜ë„ë¡ ë§Œë“¤ì–´ì•¼ ìŠ¤í”„ë§ì˜ DIë¥¼ ì ìš©í•  ìˆ˜ ìˆë‹¤. 

![image](https://user-images.githubusercontent.com/46278436/126842018-504f2823-8f39-4bd5-a64e-398dcea12bf7.png)

* ìœ„ ê·¸ë¦¼ê³¼ ê°™ì´ SqlService, SqlReader, SqlRegistry ë¼ëŠ” ì„¸ ê°œì˜ ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ê²Œ ë§Œë“¤ì–´ë„ ìƒê´€ì—†ë‹¤. 

<br>

### 1. ì¸í„°í˜ì´ìŠ¤ë¥¼ ì´ìš©í•œ ë¶„ë¦¬ 

SqlReaderì™€ SqlRegistry ë‘ ê°œì˜ ì¸í„°í˜ì´ìŠ¤ íƒ€ì… ì˜¤ë¸Œì íŠ¸ì— ì˜ì¡´í•˜ëŠ” êµ¬ì¡°ë¡œ ë§Œë“¤ì–´ë³´ì

##### SqlService ì½”ë“œ

```java
public class XmlSqlService implements SqlService {
    private SqlReader sqlReader; 
    private SqlRegistry sqlRegistry;
    
    public void setSqlReader(SqlReader sqlReader){
        this.sqlReader = sqlReader; 
    }    
    
    public void setSqlRegistry(SqlRegistry sqlRegistry){
        this.sqlRegistry = sqlRegistry;
    }
}
```

##### SqlRegistryì˜ êµ¬í˜„ ë¶€ë¶„

```java
public class XmlSqlService implements SqlService, SqlRegistry { 
    private Map<String, String> sqlMap = new HashMap<String, String>();
    
    public String findSql(String key) throws SqlNotFoundException {
        String sql = sqlMap.get(key);
        if(sql == null) throw new SqlNotFoundException(key + "ì— ëŒ€í•œ SQLì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
        
        else return sql; 
    }    
    public void registerSql(String key, String sql){
        sqlMap.put(key, sql);
    }
}    
```

##### SqlReader êµ¬í˜„ ë¶€ë¶„

: XmlSqlService í´ë˜ìŠ¤ê°€ SqlReaderë¥¼ êµ¬í˜„í•˜ë„ë¡ ë§Œë“¤ì–´ë³´ì.

```java
public class XmlSqlService implements SqlService, SqlRegistry, SqlReader {
    private String sqlmapFile;
    public void setSqlmapFile.(String sqlmapFile){
        this.sqlmapFile = sqlmapFile;
    }
    
    public void read(SqlRegistry sqlRegistry){
        String contextPath = Sqlmap.class.getPackage().getName();
        try{
        
            JAXBContext context = JAXBContext.newInstance(contextPath);
            Unmarshaller unmarshaller = context.createUnmarshaller();
            InputStream is = UserDao.calss.getResourceAsStream(sqlmapFile);
            Sqlmap sqlmap = (Sqlmap)unmarshaller.unmarshal(is);
            for(SqlType sql : sqlmap.getSql()_{
                sqlRegistry.registerSql(sql.getKey(), sql.getValue());          }           
            }        
        } catch(JAXBException e){
            throw new RuntimeException(e);
        }
    }
}

```

##### SqlService ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„ ë¶€ë¶„

```java
public class XmlSqlService implements SqlService, SqlRegistry, SqlReader {
    ...
    @PostConstruct
    public void loadSql(){
        this.sqlReader.read(this.sqlRegistry);
    }
    
    public String getSql(String key) throws SqlRetrievalFailureException {
        try {
            return this.sqlRegistry.findSql(key);
        }catch (SqlNotFoundException e){
            throw new SqlRetrievalFailureException(e);
        }
    }
}
```

### 2. ìê¸° ì°¸ì¡° ë¹ˆ ì„¤ì •

: SqlService ë¹ˆì´ SqlRegistry ì™€ SqlReaderë¥¼ ì£¼ì…ë°›ë„ë¡ ë§Œë“¤ì–´ì•¼ í•œë‹¤.

```java
<bean id="sqlService" class="springbook.user.sqlservice.XmlSqlervice">
        <property name="sqlReader" ref="sqlService" />
        <property name="sqlRegistry ref="sqlService" />
        <property name="sqlmapFile" value="sqlmap.xml" />
</bean>
```

" ìŠ¤í”„ë§ propertyì˜ ref í•­ëª©ì— ìê¸° ìì‹ ì„ ë„£ëŠ” ê²ƒì„ í—ˆìš©í•œë‹¤. "



## âš€ë””í´íŠ¸ ì˜ì¡´ê´€ê³„ 

### 1. í™•ì¥ê°€ëŠ¥í•œ ê¸°ë°˜ í´ë˜ìŠ¤

: ì•ì—ì„œ ìê¸°ì°¸ì¡°ê°€ ê°€ëŠ¥í•œ ë¹ˆìœ¼ë¡œ ë§Œë“¤ì—ˆë˜ XmlSqlService ì½”ë“œì—ì„œ ì˜ì¡´ ì¸í„°í˜ì´ìŠ¤ì™€ êµ¬í˜„ ì½”ë“œë¥¼ ì œê±°í•˜ì§€ë§Œ í•˜ë©´ ëœë‹¤.

##### SqlReaderì™€ SqlRegistry ë¥¼ ì‚¬ìš©í•˜ëŠ” SqlService êµ¬í˜„ í´ë˜ìŠ¤

```java
public class BaseSqlService implements SqlService {
    protected SqlReader sqlReader; 
    protected SqlRegistry sqlRegistry; 
    
    public void setSqlReader(SqlReader sqlReader) { this.sqlReader = sqlReader };
    public void setSqlRegistry(SqlRegistry sqlRegistry) { this.sqlRegistry = sqlRegistry; }
    
    @PostConstruct
    public void loadSql(){
        this.sqlReader.read(this.sqlRegistry);
    }
    
    public String getSql(String key) throws SqlRetrievalFailureException {
        try {
            return this.sqlRegistry.findSql(key); 
        }catch(SqlNotFoundException e){.
            throw new SqlRetrievalFailureException(e);
        }
    }
}

```

##### HashMapì„ ì´ìš©í•˜ëŠ” SqlRegistry í´ë˜ìŠ¤

: HashMapì„ ì´ìš©í•´ SQLì„ ì €ì¥í•´ë‘ê³  ì°¾ì•„ì£¼ëŠ” ê¸°ëŠ¥ì„ ë‹´ë‹¹í–ˆë˜ ì½”ë“œë¥¼ SqlRegistryë¥¼ êµ¬í˜„í•˜ëŠ” ë…ë¦½ í´ë˜ìŠ¤ë¡œ ë¶„ë¦¬í•œ ê²ƒì´ë‹¤. 

```java
public class HashMapSqlRegistry implements SqlRegistry {
    private Map<String, String> sqlMap = new HashMap<String, String>();
    
    public String findSql(String key) throws SqlNotFoundException {
        String sql = sqlMap.get(key);
        if(sql == null)
            throw new SqlNotFoundException(key + "ë¥¼ ì´ìš©í•´ì„œ SQLì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        else return sql; 
         
    }
    
    public void registerSql(String key, String sql) { sqlMap.put(key, sql); }
}
```
##### JAXBë¥¼ ì‚¬ìš©í•˜ëŠ” SqlReader í´ë˜ìŠ¤

: JAXBë¥¼ ì´ìš©í•´ XML íŒŒì¼ì—ì„œ SQL ì •ë³´ë¥¼ ì½ì–´ì˜¤ëŠ” ì½”ë“œë¥¼ SqlReader ì¸í¼í…Œì´ìŠ¤ì˜ êµ¬í˜„ í´ë˜ìŠ¤ë¡œ ë…ë¦½ì‹œí‚¬ ì°¨ë¡€ì´ë‹¤.

```java
public class JaxbXmlSqlReader implements SqlReader {
    private String sqlmapFile; // sqlmapFileì€ SqlReaderì˜ íŠ¹ì • êµ¬í˜„ ë°©ë²•ì— ì¢…ì†ë˜ëŠ” í”„ë¡œí¼í‹°ê°€ ëœë‹¤. 
    
    public void setSqlmapFile(String sqlmapFile) { this.sqlmapFile = sqlmapFile; }
    
    public void read(SqlRegistry sqlRegistry){
        ...   // XmlSqlServiceì—ì„œ ì‚¬ìš©í–ˆë˜ JAXB APIë¥¼ ì´ìš©í•´ SQLì„ ì½ì–´ì˜¤ëŠ” ì½”ë“œ ìƒëµ.
    }

}
```

##### SqlReader ì™€ SqlRegistry ì˜ ë…ë¦½ì ì¸ ë¹ˆ ì„¤ì •. 

: ê¸°ì¡´ì˜ ìì‹ ì„ ì°¸ì¡°í•˜ë„ë¡ ì„¤ì •ë˜ì–´ ìˆë˜ sqlService ë¹ˆì„ ë³„ë„ë¡œ ë“±ë¡í•œ ë‘ ê°œì˜ ë¹ˆì„ ì°¸ì¡°í•˜ë„ë¡ ë¦¬ìŠ¤íŠ¸ë¥¼ ìˆ˜ì •. 

```java
<bean id="sqlService" class="springbook.user.sqlservice.BaseSqlService">
    <property name="sqlReader" ref="sqlReader" />
    <property name="sqlRegistry" ref="sqlRegistry" />
</bean>

<bean id="sqlReader" class="spring.user.sqlservice.JaxbXmlSqlReader">
    <property name="sqlmapFile" value="sqlmap.xml" />
</bean>

<bean id="sqlRegistry" class="springbook.user.sqlservice.HashMapSqlRegistry">
</bean>
```

### 2. ë””í´íŠ¸ ì˜ì¡´ê´€ê³„ë¥¼ ê°–ëŠ” ë¹ˆ ë§Œë“¤ê¸° 

âœ ë””í´íŠ¸ ì˜ì¡´ê´€ê³„ë€ ì™¸ë¶€ì—ì„œ DI ë°›ì§€ ì•ŠëŠ” ê²½ìš° ê¸°ë³¸ì ìœ¼ë¡œ ìë™ ì ìš©ë˜ëŠ” ì˜ì¡´ê´€ê³„ë¥¼ ë§í•œë‹¤. 

##### ìƒì„±ìë¥¼ í†µí•œ ë””í´íŠ¸ ì˜ì¡´ê´€ê³„ ì„¤ì •.

```java
public class DefaultSqlService extends BaseSqlService {
    public DefaultSqlService(){
        setSqlReader(new JaxbXmlReader());
        setSqlRegistry(new HashMapSqlRegistry());        // ìƒì„±ìì—ì„œ ë””í´íŠ¸ ì˜ì¡´ ì˜¤ë¸Œì íŠ¸ë¥¼ ì§ì ‘ë§Œë“¤ì–´ì„œ ìŠ¤ìŠ¤ë¡œ DI í•´ì¤€ë‹¤.
    }

```

##### ë””í´íŠ¸ ì˜ì¡´ê´€ê³„ ë¹ˆì˜ ì„¤ì •

```JAVA
<bean id="sqlService" class="springbook.user.sqlservice.DefaultSqlService" />
```

##### ë””í´íŠ¸ ê°’ì„ ê°–ëŠ” JaxbXmlSqlReader 

```java
public class JaxbXmlSqlReader implements SqlReader {
    private static final String DEFAULT_SQLMAP_FILE = "sqlmap.xml";  // êµ³ì´ ìƒìˆ˜ë¡œ ë§Œë“¤ì§€ ì•Šê³  ë°”ë¡œ sqlmapFileì˜ ê°’ìœ¼ë¡œ ë„£ì–´ë„ ìƒê´€ì—†ì§€ë§Œ ì´ë ‡ê²Œ í•´ì£¼ë©´ ì˜ë„ê°€ ì½”ë“œì— ë¶„ëª…íˆ ë“œëŸ¬ë‚˜ê³  ì½”ë“œë„ í¼ì´ ë‚œë‹¤.
    
    public void setSqlmapFile(String sqlMapFile) { this.sqlmapFile = sqlmapFile; }
   
}
```
##### ë””í´íŠ¸ ì˜ì¡´ ì˜¤ë¸Œì íŠ¸ ëŒ€ì‹  ì‚¬ìš©í•  ë¹ˆ ì„ ì–¸

```java
<bean id="sqlService" class="springbook.user.sqlservice.DefaultSqlService" >
    <property name="sqlRegistry" ref="ultraSuperFastSqlRegistry" /> 
</bean>
```
